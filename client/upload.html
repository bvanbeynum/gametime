<html ng-app="uploadApp">
<head>
<title>GameTime Upload</title>
<style type="text/css">
.dropZone {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	display: none;
}

.dropZone.enter {
	border: 4px solid rgb(36,87,47);
	background-color: rgba(36,255,47,.3);
	display: block;
}
</style>
<body ng-controller="uploadCtl">

<div class="dropZone"
	ng-class="{enter: isOver}" 
	ondrop="angular.element(this).scope().drop(event)" 
	ondragover="angular.element(this).scope().dragOver(event)" 
	ondragleave="angular.element(this).scope().dragLeave(event)">
	
	Drop files to upload
</div>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.9/angular.min.js"></script>

<script>
/* global angular */

var log = {},
	uploadApp = angular.module("uploadApp", []);

uploadApp.controller("uploadCtl", ($scope, $http, $window) => {
	
	log.scope = $scope;
	log.http = $http;
	
	$scope.upload = { queue: [], error: [], complete: [] };
	
	$scope.saveCategory = () => {
		$scope.categories.push($scope.newCategory);
		$scope.showNewCategory = false;
		$scope.newCategory = null;
	};

	angular.element($window).on("dragenter", (event) => {
		event.stopPropagation();
		event.preventDefault();
		
		$scope.$apply(function () {
			$scope.isOver = true;
		});
	});
	
	$scope.dragOver = (event) => {
		event.stopPropagation();
		event.preventDefault();
	};
	
	$scope.dragLeave = (event) => {
		event.stopPropagation();
		event.preventDefault();
		
		$scope.$apply(function () {
			$scope.isOver = false;
		});
	};
	
	$scope.drop = (event) => {
		event.stopPropagation();
		event.preventDefault();
		
		$scope.$apply(function () {
			$scope.isOver = false;
		});
		
		var files = event.dataTransfer.files;
		log.files = files;
		
		console.log("dropped: " + files.length);
		
		$scope.upload.queue = Array.from(files);
		$scope.upload.error = [];
		$scope.upload.complete = [];
		
		uploadFiles();
		
	};
	
	function uploadFiles() {
		var formUpload = new FormData();
		formUpload.append("file", $scope.upload.queue[0]);
		
		$http({url: "/api/uploadfile", method: "post", headers: { "Content-Type": undefined }, data: formUpload }).then(
			function (response) {
				var uploadedFile = $scope.upload.queue.shift();
				$scope.upload.complete.push(uploadedFile);
				
				if ($scope.upload.queue.length > 0) {
					uploadFiles();
				}
			}, function (error) {
				console.log(error);
				
				var uploadedFile = $scope.upload.queue.shift();
				$scope.upload.error.push(uploadedFile);
				
				if ($scope.upload.queue.length > 0) {
					uploadFiles();
				}
			});
	}
	
});

</script>

</body>
</head>
</html>